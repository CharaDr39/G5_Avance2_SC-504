<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frenchies - Gestión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#121212; --panel:#16131f; --ink:#ffffff; --muted:#cfcfe6;
      --purple:#7c4dff; --purple-2:#6a3cff;
      --field:#1b1633; --field-border:#7c4dff;
      --thead:#2b2059; --row:#18132a; --grid:#3b3560; --placeholder:#e3dcff;
    }
    :root{ color-scheme:dark; }
    body{ margin:0; padding:0; background:var(--bg); color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif }
    *{ color:var(--ink) }
    ::placeholder{ color:var(--placeholder); opacity:1 }
    input,select,textarea{ color:var(--ink) !important; -webkit-text-fill-color:var(--ink) !important; caret-color:var(--ink) }

    h1{ font-size:1.8rem; margin-bottom:1rem }
    .sidebar{ position:fixed; top:0; left:0; width:250px; height:100%; background:#1e1e1e; overflow-y:auto; padding-top:1rem }
    .content{ margin-left:250px; padding:2rem }
    .card,.page{ background:var(--panel); border:1px solid #333 }
    .form-control{ background:var(--field); border:1px solid var(--field-border) }
    .form-control:focus{ background:var(--field); border-color:var(--purple); box-shadow:0 0 0 .2rem rgba(124,77,255,.25) }

    .btn{ color:#fff }
    .btn-primary{ background:var(--purple); border-color:var(--purple) }
    .btn-primary:hover{ background:var(--purple-2); border-color:var(--purple-2) }
    .btn-secondary{ background:#2a2740; border-color:#2a2740 }
    .btn-secondary:hover{ background:#3a3560; border-color:#3a3560 }
    .btn-outline-light{ color:#fff; border-color:#888 }
    .btn-outline-light:hover{ background:#333; border-color:#aaa }

    .alert-success{ background:#1f6f3e; border:1px solid #2b8a4e; color:#e8f5e9 }
    .alert-danger{ background:#7d2222; border:1px solid #aa2e2e; color:#ffebee }

    .accordion-button,.accordion-button.collapsed{ background:#1e1e1e; color:#fff; border:none }
    .accordion-button::after{ filter:invert(1) }
    .accordion-body{ background:#1e1e1e; padding:0 }
    .nav-link{ color:#fff; padding:.5rem 1rem; text-decoration:none }
    .nav-link:hover,.nav-link.active{ background:#333 }
    .nav-link.disabled{ opacity:.55; pointer-events:none }

    table.table{ color:var(--ink) }
    table.table thead{ background:var(--thead) }
    table.table tbody tr{ background:var(--row) }
    table.table td, table.table th{ border-color:var(--grid) }

    .list-group-item{ background:var(--panel); border-color:#333; color:#fff }
    .divider{ height:1px; background:#333; margin:1rem 0 }
    .hint{ font-size:.9rem; color:var(--muted) }
  </style>
</head>
<body>
  <!-- ===== SIDEBAR ===== -->
  <nav class="sidebar">
    <button class="btn btn-outline-light w-75 mx-auto mb-3" id="btn-login">Login</button>
    <div class="accordion" id="sidebarAccordion">

      <!-- Roles -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseRoles">Roles</button></h2>
        <div id="collapseRoles" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-role">Crear Rol</a></li>
            <li><a class="nav-link disabled" data-page="list-roles">Listar Roles</a></li>
            <li><a class="nav-link disabled" data-page="update-role">Actualizar Rol</a></li>
            <li><a class="nav-link disabled" data-page="delete-role">Eliminar Rol</a></li>
          </ul>
        </div>
      </div>

      <!-- Usuarios -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseUsers">Usuarios</button></h2>
        <div id="collapseUsers" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-user">Crear Usuario</a></li>
            <li><a class="nav-link disabled" data-page="list-users">Listar Usuarios</a></li>
            <li><a class="nav-link disabled" data-page="update-user">Actualizar Usuario</a></li>
            <li><a class="nav-link disabled" data-page="delete-user">Eliminar Usuario</a></li>
          </ul>
        </div>
      </div>

      <!-- Facturas -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseFacturas">Facturas</button></h2>
        <div id="collapseFacturas" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-factura">Crear Factura</a></li>
            <li><a class="nav-link disabled" data-page="list-facturas">Listar Facturas</a></li>
            <li><a class="nav-link disabled" data-page="update-factura">Actualizar Factura</a></li>
            <li><a class="nav-link disabled" data-page="delete-factura">Eliminar Factura</a></li>
            <li><a class="nav-link disabled" data-page="detalle-factura">Detalle de Factura</a></li>
          </ul>
        </div>
      </div>

      <!-- Cierres -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseCierres">Cierres</button></h2>
        <div id="collapseCierres" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-cierre">Crear Cierre</a></li>
            <li><a class="nav-link disabled" data-page="list-cierres">Listar Cierres</a></li>
            <li><a class="nav-link disabled" data-page="update-cierre">Actualizar Cierre</a></li>
            <li><a class="nav-link disabled" data-page="delete-cierre">Eliminar Cierre</a></li>
            <li><a class="nav-link disabled" data-page="movimientos-cierre">Movimientos de Caja</a></li>
          </ul>
        </div>
      </div>

      <!-- Inventario -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseInv">Inventario</button></h2>
        <div id="collapseInv" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-inv">Crear Inventario</a></li>
            <li><a class="nav-link disabled" data-page="list-inv">Listar Inventario</a></li>
            <li><a class="nav-link disabled" data-page="update-inv">Actualizar Inventario</a></li>
            <li><a class="nav-link disabled" data-page="delete-inv">Eliminar Inventario</a></li>
          </ul>
        </div>
      </div>

      <!-- Productos -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseProd">Productos</button></h2>
        <div id="collapseProd" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-prod">Crear Producto</a></li>
            <li><a class="nav-link disabled" data-page="list-prod">Listar Productos</a></li>
            <li><a class="nav-link disabled" data-page="update-prod">Actualizar Producto</a></li>
            <li><a class="nav-link disabled" data-page="delete-prod">Eliminar Producto</a></li>
          </ul>
        </div>
      </div>

      <!-- Asistencia (NUEVO) -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseAsis">Asistencia</button></h2>
        <div id="collapseAsis" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="asis-crear">Registrar Asistencia</a></li>
            <li><a class="nav-link disabled" data-page="asis-actualizar">Actualizar Asistencia</a></li>
            <li><a class="nav-link disabled" data-page="asis-eliminar">Eliminar Asistencia</a></li>
            <li><a class="nav-link disabled" data-page="asis-hoy">Asistencia (todas)</a></li>
          </ul>
        </div>
      </div>

    </div>
  </nav>

  <!-- ===== CONTENIDO ===== -->
  <div class="content">
    <h1>Frenchies - Gestión</h1>

    <!-- ===== LOGIN ===== -->
    <div id="login-page" class="page">
      <div class="card p-4">
        <h5>Iniciar Sesión</h5>
        <form id="login-form" class="mt-3">
          <input id="login-usuario" class="form-control mb-3" placeholder="Ej: CAJERO1" required />
          <input type="password" id="login-password" class="form-control mb-3" placeholder="Ej: 123" required />
          <button class="btn btn-primary">Entrar</button>
        </form>
        <div id="login-result" class="mt-2"></div>
      </div>
    </div>

    <!-- ===== ROLES ===== -->
    <div id="create-role-page" class="page d-none"><div class="card p-4">
      <h5>Crear Nuevo Rol</h5>
      <form id="role-form" class="mt-3">
        <input id="nombre" class="form-control mb-3" placeholder="Ej: CAJERO" required />
        <input id="descripcion" class="form-control mb-3" placeholder="Ej: Puede facturar" />
        <button class="btn btn-primary">Crear Rol</button>
      </form>
      <div id="result" class="mt-2"></div>
    </div></div>

    <div id="list-roles-page" class="page d-none"><div class="card p-4">
      <h5>Listado de Roles</h5>
      <button id="load-roles" class="btn btn-secondary mb-3">Cargar Roles</button>
      <ul id="roles-list" class="list-group"></ul>
    </div></div>

    <div id="update-role-page" class="page d-none"><div class="card p-4">
      <h5>Actualizar Rol</h5>
      <form id="update-form" class="mt-3">
        <input type="number" id="update-id" class="form-control mb-3" placeholder="Ej: 1" required />
        <input id="update-nombre" class="form-control mb-3" placeholder="Ej: CAJERO SENIOR" required />
        <input id="update-descripcion" class="form-control mb-3" placeholder="Ej: Cierre y reportes" />
        <button class="btn btn-primary">Actualizar</button>
      </form>
      <div id="update-result" class="mt-2"></div>
    </div></div>

    <div id="delete-role-page" class="page d-none"><div class="card p-4">
      <h5>Eliminar Rol</h5>
      <form id="delete-form" class="mt-3">
        <input type="number" id="delete-id" class="form-control mb-3" placeholder="Ej: 1" required />
        <button class="btn btn-primary">Eliminar</button>
      </form>
      <div id="delete-result" class="mt-2"></div>
    </div></div>

    <!-- ===== USUARIOS ===== -->
    <div id="create-user-page" class="page d-none"><div class="card p-4">
      <h5>Crear Usuario</h5>
      <form id="user-form" class="mt-3">
        <input id="user-usuario" class="form-control mb-3" placeholder="Ej: CAJERO1" required />
        <input type="password" id="user-password" class="form-control mb-3" placeholder="Ej: 123" required />
        <select id="user-rol-id" class="form-control mb-3" required></select>
        <button class="btn btn-primary">Crear Usuario</button>
      </form>
      <div id="user-result" class="mt-2"></div>
    </div></div>

    <div id="list-users-page" class="page d-none"><div class="card p-4">
      <h5>Listado de Usuarios</h5>
      <button id="load-users" class="btn btn-secondary mb-3">Cargar Usuarios</button>
      <ul id="users-list" class="list-group"></ul>
    </div></div>

    <div id="update-user-page" class="page d-none"><div class="card p-4">
      <h5>Actualizar Usuario</h5>
      <form id="update-user-form" class="mt-3">
        <input type="number" id="update-user-id" class="form-control mb-3" placeholder="Ej: 21" required />
        <input id="update-user-usuario" class="form-control mb-3" placeholder="Ej: CAJERO1" required />
        <input type="password" id="update-user-password" class="form-control mb-3" placeholder="Ej: 123" required />
        <select id="update-user-rol-id" class="form-control mb-3" required></select>
        <button class="btn btn-primary">Actualizar</button>
      </form>
      <div id="update-user-result" class="mt-2"></div>
    </div></div>

    <div id="delete-user-page" class="page d-none"><div class="card p-4">
      <h5>Eliminar Usuario</h5>
      <form id="delete-user-form" class="mt-3">
        <input type="number" id="delete-user-id" class="form-control mb-3" placeholder="Ej: 21" required />
        <button class="btn btn-primary">Eliminar</button>
      </form>
      <div id="delete-user-result" class="mt-2"></div>
    </div></div>

    <!-- ===== FACTURAS ===== -->
    <div id="create-factura-page" class="page d-none">
      <div class="card p-4">
        <h5>Crear Factura (con detalle)</h5>
        <p class="hint">Elige cajero y agrega líneas (Producto ID, Cantidad, Precio). Puedes añadir varias.</p>
        <form id="factura-detalle-form" class="mt-3">
          <label class="mb-1">Usuario/Cajero</label>
          <select id="factura-usuario-id" class="form-control mb-3" required></select>

          <div class="d-flex align-items-center justify-content-between">
            <h6 class="m-0">Detalle</h6>
            <button type="button" class="btn btn-secondary btn-sm" id="btn-add-item">+ Agregar línea</button>
          </div>

          <div class="table-responsive mt-2">
            <table class="table table-sm align-middle">
              <thead><tr><th>Producto ID</th><th>Cantidad</th><th>Precio (₡)</th><th></th></tr></thead>
              <tbody id="detalle-body"></tbody>
            </table>
          </div>

          <div class="divider"></div>
          <button class="btn btn-primary">Crear Factura con Detalle</button>
        </form>
        <div id="factura-result" class="mt-2"></div>
      </div>
    </div>

    <div id="list-facturas-page" class="page d-none">
      <div class="card p-4">
        <h5>Listado de Facturas</h5>
        <button id="load-facturas" class="btn btn-secondary mb-3">Cargar Facturas</button>
        <ul id="facturas-list" class="list-group"></ul>
      </div>
    </div>

    <div id="update-factura-page" class="page d-none">
      <div class="card p-4">
        <h5>Actualizar Factura</h5>
        <form id="update-factura-form" class="mt-3">
          <input type="number" id="update-factura-id" class="form-control mb-3" placeholder="Ej: 11" required />
          <input type="number" step="0.01" id="update-factura-monto" class="form-control mb-3" placeholder="Ej: 12200.00" required />
          <button class="btn btn-primary">Actualizar</button>
        </form>
        <div id="update-factura-result" class="mt-2"></div>
      </div>
    </div>

    <div id="delete-factura-page" class="page d-none">
      <div class="card p-4">
        <h5>Eliminar Factura</h5>
        <form id="delete-factura-form" class="mt-3">
          <input type="number" id="delete-factura-id" class="form-control mb-3" placeholder="Ej: 11" required />
          <button class="btn btn-primary">Eliminar Factura</button>
        </form>
        <div id="delete-factura-result" class="mt-2"></div>
      </div>
    </div>

    <div id="detalle-factura-page" class="page d-none">
      <div class="card p-4">
        <h5>Detalle de Factura</h5>
        <div class="row g-2 align-items-end">
          <div class="col-auto">
            <label>Factura ID</label>
            <input type="number" id="df-factura-id" class="form-control" placeholder="Ej: 11" />
          </div>
          <div class="col-auto"><button id="df-cargar" class="btn btn-secondary">Cargar detalle</button></div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle"><thead>
            <tr><th>ID Detalle</th><th>Producto ID</th><th>Nombre</th><th>Cantidad</th><th>Subtotal</th><th></th></tr>
          </thead><tbody id="df-body"></tbody></table>
        </div>
        <div class="divider"></div>
        <h6 class="d-none">Agregar línea</h6>
        <form id="df-add-form" class="row g-2 d-none">
          <div class="col-2"><input type="number" id="df-add-prod" class="form-control" placeholder="Ej: 101" /></div>
          <div class="col-2"><input type="number" id="df-add-cant" class="form-control" placeholder="Ej: 2" /></div>
          <div class="col-2"><input type="number" step="0.01" id="df-add-precio" class="form-control" placeholder="Ej: 5500.00" /></div>
          <div class="col-auto"><button class="btn btn-primary">Agregar</button></div>
        </form>
        <div id="df-result" class="mt-2"></div>
      </div>
    </div>

    <!-- ===== CIERRES ===== -->
    <div id="create-cierre-page" class="page d-none"><div class="card p-4">
      <h5>Crear Cierre</h5>
      <form id="cie-create-form" class="row g-3">
        <div class="col-md-3"><label>Tipo</label>
          <select id="cie-tipo" class="form-control" required>
            <option value="DIARIO">DIARIO</option><option value="SEMANAL">SEMANAL</option><option value="MENSUAL">MENSUAL</option>
          </select>
        </div>
        <div class="col-md-3"><label>Fecha</label><input type="date" id="cie-fecha" class="form-control" required /></div>
        <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary">Crear Cierre</button></div>
      </form>
      <div id="cie-create-result" class="mt-3"></div>
    </div></div>

    <div id="list-cierres-page" class="page d-none"><div class="card p-4">
      <h5>Listado de Cierres</h5>
      <button id="cie-load" class="btn btn-secondary mb-3">Cargar Cierres</button>
      <div class="table-responsive">
        <table class="table table-sm"><thead><tr><th>ID</th><th>Tipo</th><th>Fecha</th><th>Total (₡)</th></tr></thead>
          <tbody id="cie-list-body"></tbody></table>
      </div>
    </div></div>

    <div id="update-cierre-page" class="page d-none"><div class="card p-4">
      <h5>Actualizar Cierre</h5>
      <form id="cie-update-form" class="row g-3">
        <div class="col-md-2"><label>ID</label><input type="number" id="cie-upd-id" class="form-control" placeholder="Ej: 1" required /></div>
        <div class="col-md-3"><label>Tipo</label>
          <select id="cie-upd-tipo" class="form-control" required>
            <option value="DIARIO">DIARIO</option><option value="SEMANAL">SEMANAL</option><option value="MENSUAL">MENSUAL</option>
          </select>
        </div>
        <div class="col-md-3"><label>Fecha</label><input type="date" id="cie-upd-fecha" class="form-control" required /></div>
        <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary">Actualizar</button></div>
      </form>
      <div id="cie-update-result" class="mt-3"></div>
    </div></div>

    <div id="delete-cierre-page" class="page d-none"><div class="card p-4">
      <h5>Eliminar Cierre</h5>
      <form id="cie-delete-form" class="row g-3">
        <div class="col-md-3"><label>ID</label><input type="number" id="cie-del-id" class="form-control" placeholder="Ej: 1" required /></div>
        <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary">Eliminar</button></div>
      </form>
      <div id="cie-delete-result" class="mt-3"></div>
    </div></div>

    <div id="movimientos-cierre-page" class="page d-none"><div class="card p-4">
      <h5>Movimientos de Caja</h5>
      <div class="row g-2 align-items-end">
        <div class="col-auto"><label>Cierre ID</label><input type="number" id="mov-cierre-id" class="form-control" placeholder="Ej: 1" /></div>
        <div class="col-auto"><button id="mov-load" class="btn btn-secondary">Cargar</button></div>
        <div class="col-auto"><span id="mov-total" class="badge bg-primary p-2">Total: ₡0.00</span></div>
      </div>
      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle"><thead><tr><th>ID</th><th>Tipo</th><th>Descripción</th><th>Monto (₡)</th><th></th></tr></thead><tbody id="mov-body"></tbody></table>
      </div>
      <div class="divider"></div>
      <h6>Agregar movimiento</h6>
      <form id="mov-add-form" class="row g-2">
        <div class="col-md-2">
          <select id="mov-add-tipo" class="form-control"><option value="ENTRADA">ENTRADA</option><option value="SALIDA">SALIDA</option></select>
        </div>
        <div class="col-md-5"><input id="mov-add-desc" class="form-control" placeholder="Ej: Compra insumos / Apertura caja" /></div>
        <div class="col-md-2"><input type="number" step="0.01" id="mov-add-monto" class="form-control" placeholder="Ej: 15000.00" /></div>
        <div class="col-md-2"><button class="btn btn-primary">Agregar</button></div>
      </form>
      <div id="mov-result" class="mt-2"></div>
    </div></div>

    <!-- ===== INVENTARIO ===== -->
    <div id="create-inv-page" class="page d-none">
      <div class="card p-4">
        <h5>Crear Inventario</h5>
        <form id="inv-form" class="mt-3">
          <select id="inv-prod" class="form-control mb-3" required></select>
          <input type="number" step="0.01" id="inv-cant" class="form-control mb-3" placeholder="Cantidad actual (Ej: 50)" required />
          <input type="number" step="0.01" id="inv-min" class="form-control mb-3" placeholder="Stock mínimo (Ej: 10)" required />
          <button class="btn btn-primary">Crear Inventario</button>
        </form>
        <div id="inv-result" class="mt-2"></div>
      </div>
    </div>

    <div id="list-inv-page" class="page d-none">
      <div class="card p-4">
        <h5>Listado de Inventario</h5>
        <button id="load-inv" class="btn btn-secondary mb-3">Cargar Inventario</button>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>Producto</th><th>Cant. actual</th><th>Stock mín.</th><th>Actualizado</th></tr></thead>
            <tbody id="inv-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="update-inv-page" class="page d-none">
      <div class="card p-4">
        <h5>Actualizar Inventario</h5>
        <form id="inv-upd-form" class="mt-3">
          <input type="number" id="inv-upd-id" class="form-control mb-3" placeholder="ID inventario (Ej: 7)" required />
          <input type="number" step="0.01" id="inv-upd-cant" class="form-control mb-3" placeholder="Nueva cantidad (Ej: 60)" required />
          <input type="number" step="0.01" id="inv-upd-min" class="form-control mb-3" placeholder="Nuevo mínimo (Ej: 12)" required />
          <button class="btn btn-primary">Actualizar</button>
        </form>
        <div id="inv-upd-result" class="mt-2"></div>
      </div>
    </div>

    <div id="delete-inv-page" class="page d-none">
      <div class="card p-4">
        <h5>Eliminar Inventario</h5>
        <form id="inv-del-form" class="mt-3">
          <input type="number" id="inv-del-id" class="form-control mb-3" placeholder="ID inventario (Ej: 7)" required />
          <button class="btn btn-primary">Eliminar</button>
        </form>
        <div id="inv-del-result" class="mt-2"></div>
      </div>
    </div>

    <!-- ===== PRODUCTOS ===== -->
    <div id="create-prod-page" class="page d-none">
      <div class="card p-4">
        <h5>Crear Producto</h5>
        <form id="prod-form" class="row g-2">
          <div class="col-md-8"><input id="prod-nombre" class="form-control" placeholder="Ej: Combo clásico" required /></div>
          <div class="col-md-2"><input type="number" step="0.01" id="prod-precio" class="form-control" placeholder="Ej: 5500" required /></div>
          <div class="col-md-2"><button class="btn btn-primary w-100">Crear</button></div>
        </form>
        <div id="prod-result" class="mt-2"></div>
      </div>
    </div>

    <div id="list-prod-page" class="page d-none">
      <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="m-0">Listado de Productos</h5>
          <button id="load-prod" class="btn btn-secondary">Cargar</button>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>Nombre</th><th>Precio (₡)</th></tr></thead>
            <tbody id="prod-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="update-prod-page" class="page d-none">
      <div class="card p-4">
        <h5>Actualizar Producto</h5>
        <form id="prod-upd-form" class="row g-2">
          <div class="col-md-2"><input type="number" id="prod-upd-id" class="form-control" placeholder="ID" required /></div>
          <div class="col-md-6"><input id="prod-upd-nombre" class="form-control" placeholder="Nuevo nombre" required /></div>
          <div class="col-md-2"><input type="number" step="0.01" id="prod-upd-precio" class="form-control" placeholder="Nuevo precio" required /></div>
          <div class="col-md-2"><button class="btn btn-primary w-100">Actualizar</button></div>
        </form>
        <div id="prod-upd-result" class="mt-2"></div>
      </div>
    </div>

    <div id="delete-prod-page" class="page d-none">
      <div class="card p-4">
        <h5>Eliminar Producto</h5>
        <form id="prod-del-form" class="row g-2">
          <div class="col-md-3"><input type="number" id="prod-del-id" class="form-control" placeholder="ID" required /></div>
          <div class="col-md-2"><button class="btn btn-primary w-100">Eliminar</button></div>
        </form>
        <div id="prod-del-result" class="mt-2"></div>
      </div>
    </div>

    <!-- ===== ASISTENCIA (NUEVO) ===== -->
    <!-- Registrar -->
    <div id="asis-crear-page" class="page d-none">
      <div class="card p-4">
        <h5>Registrar Asistencia</h5>
        <form id="asis-create-form" class="row g-3">
          <div class="col-md-3">
            <label class="small-muted">Usuario</label>
            <select id="asis-user" class="form-control" required></select>
          </div>
          <div class="col-md-3">
            <label class="small-muted">Fecha</label>
            <input type="date" id="asis-fecha" class="form-control" required />
          </div>
          <div class="col-md-2">
            <label class="small-muted">Entrada</label>
            <input type="time" id="asis-he" class="form-control" placeholder="08:00" />
          </div>
          <div class="col-md-2">
            <label class="small-muted">Salida</label>
            <input type="time" id="asis-hs" class="form-control" placeholder="17:00" />
          </div>
          <div class="col-md-2">
            <label class="small-muted">Almuerzo</label>
            <input type="time" id="asis-ha" class="form-control" placeholder="12:30" />
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-primary">Guardar</button>
          </div>
        </form>
        <div id="asis-create-result" class="mt-2"></div>
      </div>
    </div>

    <!-- Actualizar -->
    <div id="asis-actualizar-page" class="page d-none">
      <div class="card p-4">
        <h5>Actualizar Asistencia</h5>
        <form id="asis-upd-form" class="row g-3">
          <div class="col-md-3">
            <label class="small-muted">ID Asistencia</label>
            <input type="number" id="asis-upd-id" class="form-control" placeholder="Ej: 10" required />
          </div>
          <div class="col-md-3">
            <label class="small-muted">Fecha (opcional)</label>
            <input type="date" id="asis-upd-fecha" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="small-muted">Nueva Salida</label>
            <input type="time" id="asis-upd-hs" class="form-control" placeholder="17:05" />
          </div>
          <div class="col-md-3">
            <label class="small-muted">Nuevo Almuerzo</label>
            <input type="time" id="asis-upd-ha" class="form-control" placeholder="12:40" />
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-primary">Actualizar</button>
          </div>
        </form>
        <div id="asis-upd-result" class="mt-2"></div>
      </div>
    </div>

    <!-- Eliminar -->
    <div id="asis-eliminar-page" class="page d-none">
      <div class="card p-4">
        <h5>Eliminar Asistencia</h5>
        <form id="asis-del-form" class="row g-3">
          <div class="col-md-4">
            <label class="small-muted">ID Asistencia</label>
            <input type="number" id="asis-del-id" class="form-control" placeholder="Ej: 10" required />
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary">Eliminar</button>
          </div>
        </form>
        <div id="asis-del-result" class="mt-2"></div>
      </div>
    </div>

    <!-- Reporte (ahora: todas) -->
    <div id="asis-hoy-page" class="page d-none">1
      <div class="card p-4">
        <h5>Asistencia</h5>
        <button id="asis-load-hoy" class="btn btn-secondary mb-3">Cargar</button>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>Usuario</th><th>Fecha</th><th>Entrada</th><th>Salida</th><th>Almuerzo</th>
              </tr>
            </thead>
            <tbody id="asis-hoy-body"></tbody>
          </table>
        </div>
        <div id="asis-hoy-result" class="mt-2"></div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const qs = id => document.getElementById(id);
    const clear = el => (el.innerHTML = '');
    const msgOK  = (el, t) => (el.innerHTML = '<div class="alert alert-success">'+t+'</div>');
    const msgErr = (el, t) => (el.innerHTML = '<div class="alert alert-danger">'+t+'</div>');
    const msgInfo = (el, t) => (el.innerHTML = '<div class="alert alert-secondary">'+t+'</div>');

    function showPage(name){ document.querySelectorAll('.page').forEach(p=>p.classList.add('d-none')); qs(name+'-page').classList.remove('d-none'); }
    document.getElementById('btn-login').onclick = () => showPage('login');
    document.querySelectorAll('.nav-link').forEach(a=>{
      a.onclick = e => { e.preventDefault(); if(a.classList.contains('disabled')) return;
        document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
        a.classList.add('active'); showPage(a.dataset.page);
      };
    });

    // ===== util selects
    async function loadRolesIntoSelect(id){
      const sel=qs(id); if(!sel) return; clear(sel); sel.innerHTML='<option value="">-- Rol (Ej: 1) --</option>';
      const r=await fetch('/roles'); if(!r.ok) return;
      (await r.json()).forEach(o=>{ const opt=document.createElement('option'); opt.value=o.ROL_ID; opt.textContent=`${o.ROL_ID} — ${o.NOMBRE}`; sel.appendChild(opt); });
    }
    async function loadUsersIntoSelect(id){
      const sel=qs(id); if(!sel) return; clear(sel); sel.innerHTML='<option value="">-- Usuario (Ej: 21) --</option>';
      const r=await fetch('/usuarios'); if(!r.ok) return;
      (await r.json()).forEach(u=>{ const opt=document.createElement('option'); opt.value=u.USUARIO_ID; opt.textContent=`${u.USUARIO_ID} — ${u.USUARIO}`; sel.appendChild(opt); });
    }
    async function loadProductosIntoSelect(id) {
      const sel = qs(id); if(!sel) return;
      sel.innerHTML = '<option value="">-- Producto (Ej: 101) --</option>';
      const r = await fetch('/inventario/productos'); if(!r.ok) return;
      (await r.json()).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.PRODUCTO_ID;
        opt.textContent = `${p.PRODUCTO_ID} — ${p.NOMBRE ?? ''}`;
        sel.appendChild(opt);
      });
    }

    // ===== Login
    qs('login-form').onsubmit = async e => {
      e.preventDefault();
      const usuario=qs('login-usuario').value.trim(), password=qs('login-password').value;
      const r=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario,password})});
      const div=qs('login-result'); clear(div);
      if(r.ok){ document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('disabled')); showPage('create-role'); }
      else msgErr(div,'Credenciales inválidas');
    };

    // ===== Roles
    qs('role-form').onsubmit=async e=>{ e.preventDefault();
      const nombre=qs('nombre').value.trim(), descripcion=qs('descripcion').value.trim();
      const r=await fetch('/roles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre,descripcion})});
      const div=qs('result'); clear(div); r.ok?msgOK(div,'Rol creado'):msgErr(div,'Error'); if(r.ok) e.target.reset();
    };
    qs('load-roles').onclick=async ()=>{ const list=qs('roles-list'); clear(list);
      const r=await fetch('/roles'); if(r.ok){ (await r.json()).forEach(o=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent=`ID ${o.ROL_ID}: ${o.NOMBRE} (${o.DESCRIPCION||'-'})`; list.appendChild(li); }); } else msgErr(list,'Error');
    };
    qs('update-form').onsubmit=async e=>{ e.preventDefault();
      const id=qs('update-id').value, nombre=qs('update-nombre').value.trim(), descripcion=qs('update-descripcion').value.trim();
      const r=await fetch('/roles/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre,descripcion})});
      const div=qs('update-result'); clear(div); r.status===204?msgOK(div,'Actualizado'):msgErr(div,'Error');
    };
    qs('delete-form').onsubmit=async e=>{ e.preventDefault(); const id=qs('delete-id').value;
      const r=await fetch('/roles/'+id,{method:'DELETE'}); const div=qs('delete-result'); clear(div); r.status===204?msgOK(div,'Eliminado'):msgErr(div,'Error');
    };

    // ===== Usuarios
    qs('user-form').onsubmit=async e=>{ e.preventDefault();
      const usuario=qs('user-usuario').value.trim(), password=qs('user-password').value, rolId=parseInt(qs('user-rol-id').value);
      const r=await fetch('/usuarios',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario,password,rolId})});
      const div=qs('user-result'); clear(div); r.ok?msgOK(div,'Usuario creado'):msgErr(div,'Error'); if(r.ok) e.target.reset();
    };
    qs('load-users').onclick=async ()=>{ const list=qs('users-list'); clear(list);
      const r=await fetch('/usuarios'); if(r.ok){ (await r.json()).forEach(u=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent=`ID ${u.USUARIO_ID}: ${u.USUARIO} (Rol ${u.ROL_ID})`; list.appendChild(li); }); } else msgErr(list,'Error');
    };
    qs('update-user-form').onsubmit=async e=>{ e.preventDefault();
      const id=qs('update-user-id').value, usuario=qs('update-user-usuario').value.trim(), password=qs('update-user-password').value, rolId=parseInt(qs('update-user-rol-id').value);
      const r=await fetch('/usuarios/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario,password,rolId})});
      const div=qs('update-user-result'); clear(div); r.status===204?msgOK(div,'Actualizado'):msgErr(div,'Error');
    };
    qs('delete-user-form').onsubmit=async e=>{ e.preventDefault(); const id=qs('delete-user-id').value;
      const r=await fetch('/usuarios/'+id,{method:'DELETE'}); const div=qs('delete-user-result'); clear(div); r.status===204?msgOK(div,'Eliminado'):msgErr(div,'Error');
    };

    // ===== Facturas
    const detalleBody = qs('detalle-body');
    function addItemRow(prod='', cant='', precio=''){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="number" class="form-control form-control-sm prod" placeholder="Ej: 101" value="${prod}"></td>
        <td><input type="number" class="form-control form-control-sm cant" placeholder="Ej: 2" value="${cant}"></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm precio" placeholder="Ej: 5500.00" value="${precio}"></td>
        <td class="text-end"><button type="button" class="btn btn-secondary btn-sm btn-del">−</button></td>`;
      tr.querySelector('.btn-del').onclick = () => tr.remove();
      detalleBody.appendChild(tr);
    }
    qs('btn-add-item')?.addEventListener('click', () => addItemRow());

    qs('factura-detalle-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const usuarioId = parseInt(qs('factura-usuario-id').value);
      const items = [...detalleBody.querySelectorAll('tr')].map(tr => ({
        productoId: Number(tr.querySelector('.prod').value),
        cantidad:   Number(tr.querySelector('.cant').value),
        precio:     Number(tr.querySelector('.precio').value)
      })).filter(it => it.productoId && it.cantidad && it.precio >= 0);
      const div = qs('factura-result'); clear(div);
      if (!usuarioId || items.length === 0){ msgErr(div, 'Usuario y al menos una línea son obligatorios'); return; }
      const r = await fetch('/facturas/con-detalle', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ usuarioId, items }) });
      if (!r.ok){ msgErr(div, 'Error al crear factura'); return; }
      const data = await r.json(); msgOK(div, 'Factura creada: ' + data.factura_id);
      detalleBody.innerHTML = ''; addItemRow();
    });

    qs('load-facturas')?.addEventListener('click', async () => {
      const list = qs('facturas-list'); clear(list);
      const r = await fetch('/facturas');
      if (r.ok) {
        (await r.json()).forEach(f => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.innerHTML = `ID ${f.FACTURA_ID}: ₡${f.MONTO_TOTAL} (Usr ${f.USUARIO_ID}) <div class="hint">Para editar líneas, usa "Detalle de Factura".</div>`;
          list.appendChild(li);
        });
      } else msgErr(list, 'Error');
    });

    qs('update-factura-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = qs('update-factura-id').value;
      const montoTotal = parseFloat(qs('update-factura-monto').value);
      const r = await fetch('/facturas/' + id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ montoTotal }) });
      const div = qs('update-factura-result'); clear(div);
      r.status === 204 ? msgOK(div, 'Actualizado') : msgErr(div, 'Error');
    });

    qs('delete-factura-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = qs('delete-factura-id').value;
      const r = await fetch('/facturas/' + id, { method:'DELETE' });
      const div = qs('delete-factura-result'); clear(div);
      r.status === 204 ? msgOK(div, 'Eliminado') : msgErr(div, 'Error');
    });

    // ===== Detalle de Factura
    async function loadDetalle(){
      const facturaId = parseInt(qs('df-factura-id').value);
      const tbody = qs('df-body'); clear(tbody); clear(qs('df-result'));
      if (!facturaId) return;

      const r = await fetch('/api/detalle-factura/' + facturaId);
      if (!r.ok){ msgErr(qs('df-result'), 'No se pudo cargar el detalle'); return; }
      const data = await r.json();

      data.forEach(row => {
        const idDet = row.ID_DETALLE ?? row.DETALLE_ID ?? row.detalle_id ?? row.ID ?? null;
        const prodId = row.PRODUCTO_ID ?? row.ID_PRODUCTO ?? '';
        const nombre = row.NOMBRE ?? '-';
        const cantidad = Number(row.CANTIDAD ?? 0);
        const subtotal = Number(row.SUBTOTAL ?? 0);
        const precioUnit = (row.PRECIO_UNITARIO ?? row.PRECIO ?? (cantidad>0 ? subtotal/cantidad : 0));

        const tr = document.createElement('tr');
        tr.dataset.id = idDet;
        tr.dataset.precio = precioUnit;
        tr.innerHTML = `
          <td>${idDet ?? ''}</td>
          <td>${prodId}</td>
          <td>${nombre}</td>
          <td><span class="v-cant">${cantidad}</span></td>
          <td>${subtotal}</td>
          <td class="text-end">
            <button class="btn btn-secondary btn-sm btn-edit">Editar</button>
            <button class="btn btn-primary btn-sm btn-save d-none">Guardar</button>
            <button class="btn btn-secondary btn-sm btn-cancel d-none">Cancelar</button>
          </td>`;

        const btnEdit = tr.querySelector('.btn-edit');
        const btnSave = tr.querySelector('.btn-save');
        const btnCancel = tr.querySelector('.btn-cancel');

        const toEdit = () => {
          const c = tr.querySelector('.v-cant').textContent;
          tr.children[3].innerHTML = `<input type="number" class="form-control form-control-sm e-cant" value="${c}">`;
          btnEdit.classList.add('d-none'); btnSave.classList.remove('d-none'); btnCancel.classList.remove('d-none');
        };
        const toView = (c) => {
          tr.children[3].innerHTML = `<span class="v-cant">${c}</span>`;
          btnEdit.classList.remove('d-none'); btnSave.classList.add('d-none'); btnCancel.classList.add('d-none');
        };

        btnEdit.onclick = () => toEdit();
        btnCancel.onclick = () => toView(tr.querySelector('.e-cant')?.value ?? tr.querySelector('.v-cant').textContent);
        btnSave.onclick = async () => {
          const cant = Number(tr.querySelector('.e-cant').value);
          const precio = Number(tr.dataset.precio ?? 0);
          const rr = await fetch('/api/detalle-factura/linea/' + tr.dataset.id, {
            method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ cantidad:cant, precio:precio })
          });
          if(!rr.ok){ msgErr(qs('df-result'),'Error al guardar'); return; }
          msgOK(qs('df-result'),'Línea actualizada');
          await loadDetalle();
        };

        tbody.appendChild(tr);
      });
    }
    qs('df-cargar')?.addEventListener('click', async (e)=>{ e.preventDefault(); await loadDetalle(); });

    // ===== Cierres
    qs('cie-create-form').onsubmit = async e => {
      e.preventDefault();
      const tipo = qs('cie-tipo').value, fecha = qs('cie-fecha').value;
      const r = await fetch('/cierres',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,fecha})});
      const div=qs('cie-create-result'); clear(div);
      if(!r.ok){ msgErr(div,'Error al crear cierre'); return; }
      const data=await r.json(); msgOK(div,'Cierre creado: ' + data.cierre_id);
    };
    qs('cie-load').onclick = async () => {
      const body = qs('cie-list-body'); clear(body);
      const r = await fetch('/cierres'); if(!r.ok){ body.innerHTML='<tr><td colspan="4">Error</td></tr>'; return; }
      const rows = await r.json();
      for (const c of rows){
        let total=''; try{ const t = await fetch('/cierres/'+c.ID_CIERRE+'/total'); if(t.ok){ total = (await t.json()).total; } }catch(_){}
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.ID_CIERRE??''}</td><td>${c.TIPO??''}</td>
                        <td>${(c.FECHA_CIERRE? new Date(c.FECHA_CIERRE).toLocaleDateString(): '')}</td>
                        <td>${total??''}</td>`;
        body.appendChild(tr);
      }
    };
    qs('cie-update-form').onsubmit = async e => {
      e.preventDefault();
      const id=qs('cie-upd-id').value, tipo=qs('cie-upd-tipo').value, fecha=qs('cie-upd-fecha').value;
      const r=await fetch('/cierres/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,fecha})});
      const div=qs('cie-update-result'); clear(div); r.status===204?msgOK(div,'Actualizado'):msgErr(div,'Error');
    };
    qs('cie-delete-form').onsubmit = async e => {
      e.preventDefault();
      const id=qs('cie-del-id').value;
      const r=await fetch('/cierres/'+id,{method:'DELETE'});
      const div=qs('cie-delete-result'); clear(div); r.status===204?msgOK(div,'Eliminado'):msgErr(div,'Error');
    };
    async function refreshMovTable(){
      const cierreId = parseInt(qs('mov-cierre-id').value); if(!cierreId) return;
      const body = qs('mov-body'); clear(body); clear(qs('mov-result'));
      const r = await fetch('/cierres/'+cierreId+'/movimientos');
      if(!r.ok){ msgErr(qs('mov-result'),'Error al cargar movimientos'); return; }
      (await r.json()).forEach(m=>{
        const tr=document.createElement('tr'); tr.dataset.id = m.ID_MOVIMIENTO;
        tr.innerHTML = `<td>${m.ID_MOVIMIENTO}</td><td>${m.TIPO}</td><td>${m.DESCRIPCION??''}</td><td>${m.MONTO??''}</td>
                        <td class="text-end"><button class="btn btn-danger btn-sm btn-del">Eliminar</button></td>`;
        tr.querySelector('.btn-del').onclick = async () => {
          const rr = await fetch('/movimientos/'+tr.dataset.id,{method:'DELETE'});
          if(!rr.ok){ msgErr(qs('mov-result'),'No se pudo eliminar'); return; }
          msgOK(qs('mov-result'),'Eliminado'); await refreshMovTable(); await refreshTotal();
        };
        body.appendChild(tr);
      });
    }
    async function refreshTotal(){
      const cierreId = parseInt(qs('mov-cierre-id').value); if(!cierreId) return;
      const t = await fetch('/cierres/'+cierreId+'/total');
      if(t.ok){ const val=(await t.json()).total; qs('mov-total').textContent='Total: ₡'+val; }
    }
    qs('mov-load').onclick = async (e)=>{ e.preventDefault(); await refreshMovTable(); await refreshTotal(); };
    qs('mov-add-form').onsubmit = async e => {
      e.preventDefault();
      const id = parseInt(qs('mov-cierre-id').value);
      const tipo = qs('mov-add-tipo').value;
      const descripcion = qs('mov-add-desc').value.trim();
      const monto = parseFloat(qs('mov-add-monto').value);
      if(!id || !tipo || isNaN(monto)){ msgErr(qs('mov-result'),'Datos incompletos'); return; }
      const r = await fetch('/cierres/'+id+'/movimientos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,descripcion,monto})});
      if(!r.ok){ msgErr(qs('mov-result'),'Error al agregar'); return; }
      msgOK(qs('mov-result'),'Movimiento agregado'); e.target.reset();
      await refreshMovTable(); await refreshTotal();
    };

    // ===== Inventario
    document.querySelectorAll('[data-page="create-inv"]').forEach(a => { a.addEventListener('click', () => loadProductosIntoSelect('inv-prod')); });
    qs('inv-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const productoId = parseInt(qs('inv-prod').value);
      const cantidad   = parseFloat(qs('inv-cant').value);
      const stockMin   = parseFloat(qs('inv-min').value);
      const div = qs('inv-result'); clear(div);
      const r = await fetch('/inventario', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ productoId, cantidad, stockMinimo: stockMin }) });
      r.ok ? msgOK(div,'Inventario creado') : msgErr(div,'Error al crear');
      if (r.ok) e.target.reset();
    });
    qs('load-inv')?.addEventListener('click', async () => {
      const tbody = qs('inv-list'); clear(tbody);
      const r = await fetch('/inventario');
      if (!r.ok) { tbody.innerHTML = '<tr><td colspan="5">Error</td></tr>'; return; }
      (await r.json()).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.ID_INVENTARIO ?? ''}</td>
                        <td>${(row.PRODUCTO_ID ?? '') + (row.NOMBRE ? ' — ' + row.NOMBRE : '')}</td>
                        <td>${row.CANTIDAD_ACTUAL ?? ''}</td>
                        <td>${row.STOCK_MINIMO ?? ''}</td>
                        <td>${row.FECHA_ACTUALIZACION ?? ''}</td>`;
        tbody.appendChild(tr);
      });
    });
    qs('inv-upd-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = parseInt(qs('inv-upd-id').value), cant = parseFloat(qs('inv-upd-cant').value), minimo = parseFloat(qs('inv-upd-min').value);
      const div = qs('inv-upd-result'); clear(div);
      const r = await fetch('/inventario/' + id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ cantidad: cant, stockMinimo: minimo }) });
      div.innerHTML = (r.status === 204) ? '<div class="alert alert-success">Actualizado</div>' : '<div class="alert alert-danger">Error</div>';
    });
    qs('inv-del-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id  = parseInt(qs('inv-del-id').value);
      const div = qs('inv-del-result'); clear(div);
      const r = await fetch('/inventario/' + id, { method:'DELETE' });
      div.innerHTML = (r.status === 204) ? '<div class="alert alert-success">Eliminado</div>' : '<div class="alert alert-danger">Error</div>';
    });

    // ===== Productos
    qs('prod-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const nombre = qs('prod-nombre').value.trim();
      const precio = parseFloat(qs('prod-precio').value);
      const div = qs('prod-result'); clear(div);
      const r = await fetch('/productos', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ nombre, precio }) });
      r.ok ? msgOK(div,'Producto creado') : msgErr(div,'Error al crear');
      if (r.ok) e.target.reset();
    });
    qs('load-prod')?.addEventListener('click', async () => {
      const tbody = qs('prod-list'); clear(tbody);
      const r = await fetch('/productos');
      if (!r.ok) { tbody.innerHTML = '<tr><td colspan="3">Error</td></tr>'; return; }
      (await r.json()).forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.PRODUCTO_ID}</td><td>${p.NOMBRE ?? ''}</td><td>${p.PRECIO ?? ''}</td>`;
        tbody.appendChild(tr);
      });
    });
    qs('prod-upd-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = parseInt(qs('prod-upd-id').value);
      const nombre = qs('prod-upd-nombre').value.trim();
      const precio = parseFloat(qs('prod-upd-precio').value);
      const div = qs('prod-upd-result'); clear(div);
      const r = await fetch('/productos/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ nombre, precio }) });
      div.innerHTML = (r.status === 204) ? '<div class="alert alert-success">Actualizado</div>' : '<div class="alert alert-danger">Error</div>';
    });
    qs('prod-del-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = parseInt(qs('prod-del-id').value);
      const div = qs('prod-del-result'); clear(div);
      const r = await fetch('/productos/'+id, { method:'DELETE' });
      div.innerHTML = (r.status === 204) ? '<div class="alert alert-success">Eliminado</div>' : '<div class="alert alert-danger">Error</div>';
    });

    // ===== Asistencia (NUEVO)
    document.querySelectorAll('[data-page="asis-crear"]').forEach(a=>{
      a.addEventListener('click', ()=> loadUsersIntoSelect('asis-user'));
    });

    // crear
    qs('asis-create-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const usuarioId = parseInt(qs('asis-user').value);
      const fecha = qs('asis-fecha').value;
      const horaEntrada  = qs('asis-he').value;
      const horaSalida   = qs('asis-hs').value;
      const horaAlmuerzo = qs('asis-ha').value;
      const div = qs('asis-create-result'); clear(div);
      const r = await fetch('/asistencia', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ usuarioId, fecha, horaEntrada, horaSalida, horaAlmuerzo })
      });
      if(!r.ok){ msgErr(div,'Error al registrar'); return; }
      const data = await r.json();
      msgOK(div, 'Asistencia registrada. ID: '+data.asistencia_id);
      e.target.reset();
    });

    // actualizar
    qs('asis-upd-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = parseInt(qs('asis-upd-id').value);
      const fecha = qs('asis-upd-fecha').value; // opcional
      const horaSalida   = qs('asis-upd-hs').value;
      const horaAlmuerzo = qs('asis-upd-ha').value;
      const div = qs('asis-upd-result'); clear(div);
      const r = await fetch('/asistencia/'+id,{
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ fecha, horaSalida, horaAlmuerzo })
      });
      r.status===204 ? msgOK(div,'Actualizado') : msgErr(div,'Error');
    });

    // eliminar
    qs('asis-del-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = parseInt(qs('asis-del-id').value);
      const div = qs('asis-del-result'); clear(div);
      const r = await fetch('/asistencia/'+id,{ method:'DELETE' });
      r.status===204 ? msgOK(div,'Eliminado') : msgErr(div,'Error');
    });

    // ===== Asistencia (todas): carga general ordenada por fecha (más recientes primero)
    qs('asis-load-hoy')?.addEventListener('click', async () => {
      const tbody = qs('asis-hoy-body'); clear(tbody);
      const div = qs('asis-hoy-result'); clear(div);

      // intenta /asistencia y si no existe, prueba /asistencias
      const tryEndpoints = async () => {
        let resp = await fetch('/asistencia');
        if (resp.status === 404) resp = await fetch('/asistencias');
        return resp;
      };

      const r = await tryEndpoints();
      if (r.status === 204) { msgInfo(div,'No hay registros de asistencia.'); return; }
      if (!r.ok) { msgErr(div, 'No se pudo cargar ('+r.status+').'); return; }

      let json = null;
      try { json = await r.json(); } catch(_) { msgInfo(div,'Sin datos.'); return; }

      // normaliza posibles formas de respuesta
      let rows = [];
      if (Array.isArray(json)) rows = json;
      else if (json?.rows && Array.isArray(json.rows)) rows = json.rows;
      else if (json?.RESULT && Array.isArray(json.RESULT)) rows = json.RESULT;
      else if (json?.result && Array.isArray(json.result)) rows = json.result;
      else if (json?.data && Array.isArray(json.data)) rows = json.data;

      if (!Array.isArray(rows) || rows.length === 0) { msgInfo(div,'No hay registros de asistencia.'); return; }

      const toTs = (f) => {
        if (!f) return 0;
        if (typeof f === 'number') {
          const n = Number(f);
          return (n > 1e12) ? n : (n > 1e9 ? n*1000 : n); // ms / s / fallback
        }
        if (typeof f === 'string') {
          let m = f.match(/(\d{4})-(\d{2})-(\d{2})/); // YYYY-MM-DD
          if (m) return new Date(Number(m[1]), Number(m[2])-1, Number(m[3])).getTime();
          m = f.match(/(\d{2})\/(\d{2})\/(\d{4})/);    // DD/MM/YYYY
          if (m) return new Date(Number(m[3]), Number(m[2])-1, Number(m[1])).getTime();
          const t = Date.parse(f);
          if (!isNaN(t)) return t;
        }
        return 0;
      };

      rows.sort((a,b) => toTs((b.FECHA ?? b.FECHA_ASISTENCIA ?? b.fecha)) - toTs((a.FECHA ?? a.FECHA_ASISTENCIA ?? a.fecha)));

      const fmtDate = (f) => {
        const ts = toTs(f);
        return ts ? new Date(ts).toLocaleDateString() : (typeof f === 'string' ? f : '');
      };
      const fmtTime = t => {
        if (t == null) return '';
        if (typeof t === 'string') {
          const m = t.match(/(\d{2}:\d{2})/);
          return m ? m[1] : t;
        }
        return ''+t;
      };

      rows.forEach(o=>{
        const id  = o.ASISTENCIA_ID ?? o.ID ?? o.id ?? '';
        const usr = o.USUARIO ?? o.USUARIO_ID ?? o.usuario ?? '';
        const fecha = fmtDate(o.FECHA ?? o.FECHA_ASISTENCIA ?? o.fecha);

        const he = fmtTime(o.HORA_ENTRADA ?? o.ENTRADA ?? o.horaEntrada);
        const hs = fmtTime(o.HORA_SALIDA  ?? o.SALIDA  ?? o.horaSalida);
        const ha = fmtTime(o.HORA_ALMUERZO?? o.ALMUERZO?? o.horaAlmuerzo);

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${id}</td><td>${usr}</td><td>${fecha}</td><td>${he}</td><td>${hs}</td><td>${ha}</td>`;
        tbody.appendChild(tr);
      });
    });

    // ===== init
    (function init(){
      document.querySelectorAll('.nav-link').forEach(n=>n.classList.add('disabled'));
      loadRolesIntoSelect('user-rol-id');
      loadRolesIntoSelect('update-user-rol-id');
      loadUsersIntoSelect('factura-usuario-id');
      const el = document.getElementById('detalle-body'); if(el && el.children.length===0){ addItemRow(); }
      showPage('login');
    })();
  </script>
</body>
</html>
