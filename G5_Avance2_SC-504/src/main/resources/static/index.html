<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frenchies - Gestión</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#121212; --panel:#16131f; --ink:#ffffff; --muted:#cfcfe6;
      --purple:#7c4dff; --purple-2:#6a3cff;
      --field:#1b1633; --field-border:#7c4dff;
      --thead:#2b2059; --row:#18132a; --grid:#3b3560; --placeholder:#e3dcff;
    }
    :root{ color-scheme:dark; }

    body{ margin:0; padding:0; background:var(--bg); color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif }
    *{ color:var(--ink) }
    ::placeholder{ color:var(--placeholder); opacity:1; }
    /* fuerza texto blanco al escribir (Chrome/WebKit) */
    input,select,textarea{ color:var(--ink) !important; -webkit-text-fill-color:var(--ink) !important; caret-color:var(--ink); }

    h1{ font-size:1.8rem; margin-bottom:1rem }
    .sidebar{ position:fixed; top:0; left:0; width:250px; height:100%; background:#1e1e1e; overflow-y:auto; padding-top:1rem }
    .content{ margin-left:250px; padding:2rem }
    .card,.page{ background:var(--panel); border:1px solid #333 }
    .card h5{ color:var(--ink) }

    .form-control{ background:var(--field); border:1px solid var(--field-border); color:var(--ink) }
    .form-control:focus{ background:var(--field); border-color:var(--purple); box-shadow:0 0 0 .2rem rgba(124,77,255,.25) }

    .btn{ color:#fff }
    .btn-primary{ background:var(--purple); border-color:var(--purple) }
    .btn-primary:hover{ background:var(--purple-2); border-color:var(--purple-2) }
    .btn-secondary{ background:#2a2740; border-color:#2a2740 }
    .btn-secondary:hover{ background:#3a3560; border-color:#3a3560 }
    .btn-outline-light{ color:#fff; border-color:#888 }
    .btn-outline-light:hover{ background:#333; border-color:#aaa }

    .alert-success{ background:#1f6f3e; border:1px solid #2b8a4e; color:#e8f5e9 }
    .alert-danger{ background:#7d2222; border:1px solid #aa2e2e; color:#ffebee }

    .accordion-button,.accordion-button.collapsed{ background:#1e1e1e; color:#fff; border:none }
    .accordion-button::after{ filter:invert(1) }
    .accordion-body{ background:#1e1e1e; padding:0 }
    .accordion-item{ background:#1e1e1e; border:none }
    .nav-link{ color:#fff; padding:.5rem 1rem; text-decoration:none }
    .nav-link:hover,.nav-link.active{ background:#333 }
    .nav-link.disabled{ opacity:.55; pointer-events:none }

    table.table{ color:var(--ink) }
    table.table thead{ background:var(--thead); color:var(--ink) }
    table.table tbody tr{ background:var(--row) }
    table.table td, table.table th{ border-color:var(--grid) }

    .list-group-item{ background:var(--panel); border-color:#333; color:#fff }
    .small-muted{ opacity:.85; color:var(--muted) }
    .divider{ height:1px; background:#333; margin:1rem 0 }
    .hint{ font-size:.9rem; color:var(--muted) }
  </style>
</head>

<body>
  <!-- ===== SIDEBAR ===== -->
  <nav class="sidebar">
    <button class="btn btn-outline-light w-75 mx-auto mb-3" id="btn-login">Login</button>

    <div class="accordion" id="sidebarAccordion">
      <!-- Roles -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRoles">Roles</button></h2>
        <div id="collapseRoles" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-role">Crear Rol</a></li>
            <li><a class="nav-link disabled" data-page="list-roles">Listar Roles</a></li>
            <li><a class="nav-link disabled" data-page="update-role">Actualizar Rol</a></li>
            <li><a class="nav-link disabled" data-page="delete-role">Eliminar Rol</a></li>
          </ul>
        </div>
      </div>

      <!-- Usuarios -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUsers">Usuarios</button></h2>
        <div id="collapseUsers" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-user">Crear Usuario</a></li>
            <li><a class="nav-link disabled" data-page="list-users">Listar Usuarios</a></li>
            <li><a class="nav-link disabled" data-page="update-user">Actualizar Usuario</a></li>
            <li><a class="nav-link disabled" data-page="delete-user">Eliminar Usuario</a></li>
          </ul>
        </div>
      </div>

      <!-- Facturas -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFacturas">Facturas</button></h2>
        <div id="collapseFacturas" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-factura">Crear Factura</a></li>
            <li><a class="nav-link disabled" data-page="list-facturas">Listar Facturas</a></li>
            <li><a class="nav-link disabled" data-page="update-factura">Actualizar Factura</a></li>
            <li><a class="nav-link disabled" data-page="delete-factura">Eliminar Factura</a></li>
            <li><a class="nav-link disabled" data-page="detalle-factura">Detalle de Factura</a></li>
          </ul>
        </div>
      </div>

      <!-- Cierres -->
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCierres">Cierres</button></h2>
        <div id="collapseCierres" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
          <ul class="nav flex-column accordion-body p-0">
            <li><a class="nav-link disabled" data-page="create-cierre">Crear Cierre</a></li>
            <li><a class="nav-link disabled" data-page="list-cierres">Listar Cierres</a></li>
            <li><a class="nav-link disabled" data-page="update-cierre">Actualizar Cierre</a></li>
            <li><a class="nav-link disabled" data-page="delete-cierre">Eliminar Cierre</a></li>
            <li><a class="nav-link disabled" data-page="movimientos-cierre">Movimientos de Caja</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- ===== CONTENIDO ===== -->
  <div class="content">
    <h1>Frenchies - Gestión</h1>

    <!-- ===== LOGIN ===== -->
    <div id="login-page" class="page">
      <div class="card p-4">
        <h5>Iniciar Sesión</h5>
        <form id="login-form" class="mt-3">
          <input id="login-usuario" class="form-control mb-3" placeholder="Ej: CAJERO1" required />
          <input type="password" id="login-password" class="form-control mb-3" placeholder="Ej: 123" required />
          <button class="btn btn-primary">Entrar</button>
        </form>
        <div id="login-result" class="mt-2"></div>
      </div>
    </div>

    <!-- ===== ROLES ===== -->
    <div id="create-role-page" class="page d-none"><div class="card p-4">
      <h5>Crear Nuevo Rol</h5>
      <form id="role-form" class="mt-3">
        <input id="nombre" class="form-control mb-3" placeholder="Ej: CAJERO" required />
        <input id="descripcion" class="form-control mb-3" placeholder="Ej: Puede facturar" />
        <button class="btn btn-primary">Crear Rol</button>
      </form>
      <div id="result" class="mt-2"></div>
    </div></div>

    <div id="list-roles-page" class="page d-none"><div class="card p-4">
      <h5>Listado de Roles</h5>
      <button id="load-roles" class="btn btn-secondary mb-3">Cargar Roles</button>
      <ul id="roles-list" class="list-group"></ul>
    </div></div>

    <div id="update-role-page" class="page d-none"><div class="card p-4">
      <h5>Actualizar Rol</h5>
      <form id="update-form" class="mt-3">
        <input type="number" id="update-id" class="form-control mb-3" placeholder="Ej: 1" required />
        <input id="update-nombre" class="form-control mb-3" placeholder="Ej: CAJERO SENIOR" required />
        <input id="update-descripcion" class="form-control mb-3" placeholder="Ej: Cierre y reportes" />
        <button class="btn btn-primary">Actualizar</button>
      </form>
      <div id="update-result" class="mt-2"></div>
    </div></div>

    <div id="delete-role-page" class="page d-none"><div class="card p-4">
      <h5>Eliminar Rol</h5>
      <form id="delete-form" class="mt-3">
        <input type="number" id="delete-id" class="form-control mb-3" placeholder="Ej: 1" required />
        <button class="btn btn-primary">Eliminar</button>
      </form>
      <div id="delete-result" class="mt-2"></div>
    </div></div>

    <!-- ===== USUARIOS ===== -->
    <div id="create-user-page" class="page d-none"><div class="card p-4">
      <h5>Crear Usuario</h5>
      <form id="user-form" class="mt-3">
        <input id="user-usuario" class="form-control mb-3" placeholder="Ej: CAJERO1" required />
        <input type="password" id="user-password" class="form-control mb-3" placeholder="Ej: 123" required />
        <select id="user-rol-id" class="form-control mb-3" required></select>
        <button class="btn btn-primary">Crear Usuario</button>
      </form>
      <div id="user-result" class="mt-2"></div>
    </div></div>

    <div id="list-users-page" class="page d-none"><div class="card p-4">
      <h5>Listado de Usuarios</h5>
      <button id="load-users" class="btn btn-secondary mb-3">Cargar Usuarios</button>
      <ul id="users-list" class="list-group"></ul>
    </div></div>

    <div id="update-user-page" class="page d-none"><div class="card p-4">
      <h5>Actualizar Usuario</h5>
      <form id="update-user-form" class="mt-3">
        <input type="number" id="update-user-id" class="form-control mb-3" placeholder="Ej: 21" required />
        <input id="update-user-usuario" class="form-control mb-3" placeholder="Ej: CAJERO1" required />
        <input type="password" id="update-user-password" class="form-control mb-3" placeholder="Ej: 123" required />
        <select id="update-user-rol-id" class="form-control mb-3" required></select>
        <button class="btn btn-primary">Actualizar</button>
      </form>
      <div id="update-user-result" class="mt-2"></div>
    </div></div>

    <div id="delete-user-page" class="page d-none"><div class="card p-4">
      <h5>Eliminar Usuario</h5>
      <form id="delete-user-form" class="mt-3">
        <input type="number" id="delete-user-id" class="form-control mb-3" placeholder="Ej: 21" required />
        <button class="btn btn-primary">Eliminar</button>
      </form>
      <div id="delete-user-result" class="mt-2"></div>
    </div></div>

    <!-- ===== FACTURAS (resumen, igual a lo que ya tenías) ===== -->
    <!-- (Se conservan tus páginas de crear/listar/actualizar/eliminar y la de detalle) -->
    <!-- … (omite aquí para no duplicar; deja tus secciones actuales tal cual) … -->

    <!-- ===== CIERRES ===== -->
    <div id="create-cierre-page" class="page d-none"><div class="card p-4">
      <h5>Crear Cierre</h5>
      <form id="cie-create-form" class="row g-3">
        <div class="col-md-3">
          <label class="small-muted">Tipo</label>
          <select id="cie-tipo" class="form-control" required>
            <option value="DIARIO">DIARIO</option>
            <option value="SEMANAL">SEMANAL</option>
            <option value="MENSUAL">MENSUAL</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="small-muted">Fecha</label>
          <input type="date" id="cie-fecha" class="form-control" required />
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary">Crear Cierre</button>
        </div>
      </form>
      <div id="cie-create-result" class="mt-3"></div>
    </div></div>

    <div id="list-cierres-page" class="page d-none"><div class="card p-4">
      <h5>Listado de Cierres</h5>
      <button id="cie-load" class="btn btn-secondary mb-3">Cargar Cierres</button>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>ID</th><th>Tipo</th><th>Fecha</th><th>Total (₡)</th></tr></thead>
          <tbody id="cie-list-body"></tbody>
        </table>
      </div>
    </div></div>

    <div id="update-cierre-page" class="page d-none"><div class="card p-4">
      <h5>Actualizar Cierre</h5>
      <form id="cie-update-form" class="row g-3">
        <div class="col-md-2">
          <label class="small-muted">ID</label>
          <input type="number" id="cie-upd-id" class="form-control" placeholder="Ej: 1" required />
        </div>
        <div class="col-md-3">
          <label class="small-muted">Tipo</label>
          <select id="cie-upd-tipo" class="form-control" required>
            <option value="DIARIO">DIARIO</option>
            <option value="SEMANAL">SEMANAL</option>
            <option value="MENSUAL">MENSUAL</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="small-muted">Fecha</label>
          <input type="date" id="cie-upd-fecha" class="form-control" required />
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary">Actualizar</button>
        </div>
      </form>
      <div id="cie-update-result" class="mt-3"></div>
    </div></div>

    <div id="delete-cierre-page" class="page d-none"><div class="card p-4">
      <h5>Eliminar Cierre</h5>
      <form id="cie-delete-form" class="row g-3">
        <div class="col-md-3">
          <label class="small-muted">ID</label>
          <input type="number" id="cie-del-id" class="form-control" placeholder="Ej: 1" required />
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary">Eliminar</button>
        </div>
      </form>
      <div id="cie-delete-result" class="mt-3"></div>
    </div></div>

    <div id="movimientos-cierre-page" class="page d-none"><div class="card p-4">
      <h5>Movimientos de Caja</h5>
      <div class="row g-2 align-items-end">
        <div class="col-auto">
          <label class="small-muted">Cierre ID</label>
          <input type="number" id="mov-cierre-id" class="form-control" placeholder="Ej: 1" />
        </div>
        <div class="col-auto">
          <button id="mov-load" class="btn btn-secondary">Cargar</button>
        </div>
        <div class="col-auto">
          <span id="mov-total" class="badge bg-primary p-2">Total: ₡0.00</span>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead><tr><th>ID</th><th>Tipo</th><th>Descripción</th><th>Monto (₡)</th><th style="width:150px"></th></tr></thead>
          <tbody id="mov-body"></tbody>
        </table>
      </div>

      <div class="divider"></div>
      <h6>Agregar movimiento</h6>
      <form id="mov-add-form" class="row g-2">
        <div class="col-md-2">
          <select id="mov-add-tipo" class="form-control">
            <option value="ENTRADA">ENTRADA</option>
            <option value="SALIDA">SALIDA</option>
          </select>
        </div>
        <div class="col-md-5">
          <input id="mov-add-desc" class="form-control" placeholder="Ej: Compra insumos / Apertura caja" />
        </div>
        <div class="col-md-2">
          <input type="number" step="0.01" id="mov-add-monto" class="form-control" placeholder="Ej: 15000.00" />
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary">Agregar</button>
        </div>
      </form>
      <div id="mov-result" class="mt-2"></div>
    </div></div>

    <!-- ===== DETALLE DE FACTURA (tu sección existente) ===== -->
    <!-- Mantén tu sección de “detalle-factura” como ya la tienes -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const qs = id => document.getElementById(id);
    const clear = el => (el.innerHTML = '');
    const msgOK  = (el, t) => (el.innerHTML = '<div class="alert alert-success">'+t+'</div>');
    const msgErr = (el, t) => (el.innerHTML = '<div class="alert alert-danger">'+t+'</div>');

    function showPage(name){ document.querySelectorAll('.page').forEach(p=>p.classList.add('d-none')); qs(name+'-page').classList.remove('d-none'); }
    document.getElementById('btn-login').onclick = () => showPage('login');
    document.querySelectorAll('.nav-link').forEach(a=>{
      a.onclick = e => { e.preventDefault(); if(a.classList.contains('disabled')) return;
        document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active')); a.classList.add('active'); showPage(a.dataset.page);
      };
    });

    async function loadRolesIntoSelect(id){
      const sel=qs(id); clear(sel); sel.innerHTML='<option value="">-- Rol (Ej: 1) --</option>';
      const r=await fetch('/roles'); if(!r.ok) return;
      (await r.json()).forEach(o=>{ const opt=document.createElement('option'); opt.value=o.ROL_ID; opt.textContent=`${o.ROL_ID} — ${o.NOMBRE}`; sel.appendChild(opt); });
    }
    async function loadUsersIntoSelect(id){
      const sel=qs(id); clear(sel); sel.innerHTML='<option value="">-- Usuario (Ej: 21) --</option>';
      const r=await fetch('/usuarios'); if(!r.ok) return;
      (await r.json()).forEach(u=>{ const opt=document.createElement('option'); opt.value=u.USUARIO_ID; opt.textContent=`${u.USUARIO_ID} — ${u.USUARIO}`; sel.appendChild(opt); });
    }

    // ===== Login
    qs('login-form').onsubmit = async e => {
      e.preventDefault();
      const usuario=qs('login-usuario').value.trim(), password=qs('login-password').value;
      const r=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario,password})});
      const div=qs('login-result'); clear(div);
      if(r.ok){ document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('disabled')); showPage('create-role'); }
      else msgErr(div,'Credenciales inválidas');
    };

    // ===== Roles (igual a antes)
    qs('role-form').onsubmit=async e=>{ e.preventDefault();
      const nombre=qs('nombre').value.trim(), descripcion=qs('descripcion').value.trim();
      const r=await fetch('/roles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre,descripcion})});
      const div=qs('result'); clear(div); r.ok?msgOK(div,'Rol creado'):msgErr(div,'Error'); if(r.ok) e.target.reset();
    };
    qs('load-roles').onclick=async ()=>{ const list=qs('roles-list'); clear(list);
      const r=await fetch('/roles'); if(r.ok){ (await r.json()).forEach(o=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent=`ID ${o.ROL_ID}: ${o.NOMBRE} (${o.DESCRIPCION||'-'})`; list.appendChild(li); }); } else msgErr(list,'Error');
    };
    qs('update-form').onsubmit=async e=>{ e.preventDefault();
      const id=qs('update-id').value, nombre=qs('update-nombre').value.trim(), descripcion=qs('update-descripcion').value.trim();
      const r=await fetch('/roles/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre,descripcion})});
      const div=qs('update-result'); clear(div); r.status===204?msgOK(div,'Actualizado'):msgErr(div,'Error');
    };
    qs('delete-form').onsubmit=async e=>{ e.preventDefault(); const id=qs('delete-id').value;
      const r=await fetch('/roles/'+id,{method:'DELETE'}); const div=qs('delete-result'); clear(div); r.status===204?msgOK(div,'Eliminado'):msgErr(div,'Error');
    };

    // ===== Usuarios (igual a antes)
    qs('user-form').onsubmit=async e=>{ e.preventDefault();
      const usuario=qs('user-usuario').value.trim(), password=qs('user-password').value, rolId=parseInt(qs('user-rol-id').value);
      const r=await fetch('/usuarios',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario,password,rolId})});
      const div=qs('user-result'); clear(div); r.ok?msgOK(div,'Usuario creado'):msgErr(div,'Error'); if(r.ok) e.target.reset();
    };
    qs('load-users').onclick=async ()=>{ const list=qs('users-list'); clear(list);
      const r=await fetch('/usuarios'); if(r.ok){ (await r.json()).forEach(u=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent=`ID ${u.USUARIO_ID}: ${u.USUARIO} (Rol ${u.ROL_ID})`; list.appendChild(li); }); } else msgErr(list,'Error');
    };
    qs('update-user-form').onsubmit=async e=>{ e.preventDefault();
      const id=qs('update-user-id').value, usuario=qs('update-user-usuario').value.trim(), password=qs('update-user-password').value, rolId=parseInt(qs('update-user-rol-id').value);
      const r=await fetch('/usuarios/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario,password,rolId})});
      const div=qs('update-user-result'); clear(div); r.status===204?msgOK(div,'Actualizado'):msgErr(div,'Error');
    };
    qs('delete-user-form').onsubmit=async e=>{ e.preventDefault(); const id=qs('delete-user-id').value;
      const r=await fetch('/usuarios/'+id,{method:'DELETE'}); const div=qs('delete-user-result'); clear(div); r.status===204?msgOK(div,'Eliminado'):msgErr(div,'Error');
    };

    // ===== Cierres
    qs('cie-create-form').onsubmit = async e => {
      e.preventDefault();
      const tipo = qs('cie-tipo').value;
      const fecha = qs('cie-fecha').value; // yyyy-MM-dd
      const r = await fetch('/cierres',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,fecha})});
      const div=qs('cie-create-result'); clear(div);
      if(!r.ok){ msgErr(div,'Error al crear cierre'); return; }
      const data=await r.json(); msgOK(div,'Cierre creado: '+data.cierre_id);
    };

    qs('cie-load').onclick = async () => {
      const body = qs('cie-list-body'); clear(body);
      const r = await fetch('/cierres'); if(!r.ok){ body.innerHTML='<tr><td colspan="4">Error</td></tr>'; return; }
      const rows = await r.json();
      for (const c of rows){
        // consulta total por cierre
        let total=''; try{
          const t = await fetch('/cierres/'+c.ID_CIERRE+'/total');
          if(t.ok){ total = (await t.json()).total; }
        }catch(_){}
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.ID_CIERRE??''}</td><td>${c.TIPO??''}</td>
                        <td>${(c.FECHA_CIERRE? new Date(c.FECHA_CIERRE).toLocaleDateString(): '')}</td>
                        <td>${total??''}</td>`;
        body.appendChild(tr);
      }
    };

    qs('cie-update-form').onsubmit = async e => {
      e.preventDefault();
      const id=qs('cie-upd-id').value, tipo=qs('cie-upd-tipo').value, fecha=qs('cie-upd-fecha').value;
      const r=await fetch('/cierres/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,fecha})});
      const div=qs('cie-update-result'); clear(div); r.status===204?msgOK(div,'Actualizado'):msgErr(div,'Error');
    };

    qs('cie-delete-form').onsubmit = async e => {
      e.preventDefault();
      const id=qs('cie-del-id').value;
      const r=await fetch('/cierres/'+id,{method:'DELETE'});
      const div=qs('cie-delete-result'); clear(div); r.status===204?msgOK(div,'Eliminado'):msgErr(div,'Error');
    };

    // ===== Movimientos de Caja
    async function refreshMovTable(){
      const cierreId = parseInt(qs('mov-cierre-id').value); if(!cierreId) return;
      const body = qs('mov-body'); clear(body); clear(qs('mov-result'));

      const r = await fetch('/cierres/'+cierreId+'/movimientos');
      if(!r.ok){ msgErr(qs('mov-result'),'Error al cargar movimientos'); return; }
      (await r.json()).forEach(m=>{
        const tr=document.createElement('tr');
        tr.dataset.id = m.ID_MOVIMIENTO;
        tr.innerHTML = `
          <td>${m.ID_MOVIMIENTO}</td>
          <td>${m.TIPO}</td>
          <td>${m.DESCRIPCION??''}</td>
          <td>${m.MONTO??''}</td>
          <td class="text-end">
            <button class="btn btn-danger btn-sm btn-del">Eliminar</button>
          </td>`;
        tr.querySelector('.btn-del').onclick = async () => {
          const rr = await fetch('/movimientos/'+tr.dataset.id,{method:'DELETE'});
          if(!rr.ok){ msgErr(qs('mov-result'),'No se pudo eliminar'); return; }
          msgOK(qs('mov-result'),'Eliminado'); await refreshMovTable(); await refreshTotal();
        };
        body.appendChild(tr);
      });
    }

    async function refreshTotal(){
      const cierreId = parseInt(qs('mov-cierre-id').value); if(!cierreId) return;
      const t = await fetch('/cierres/'+cierreId+'/total');
      if(t.ok){ const val=(await t.json()).total; qs('mov-total').textContent='Total: ₡'+val; }
    }

    qs('mov-load').onclick = async (e)=>{ e.preventDefault(); await refreshMovTable(); await refreshTotal(); };

    qs('mov-add-form').onsubmit = async e => {
      e.preventDefault();
      const id = parseInt(qs('mov-cierre-id').value);
      const tipo = qs('mov-add-tipo').value;
      const descripcion = qs('mov-add-desc').value.trim();
      const monto = parseFloat(qs('mov-add-monto').value);
      if(!id || !tipo || isNaN(monto)){ msgErr(qs('mov-result'),'Datos incompletos'); return; }
      const r = await fetch('/cierres/'+id+'/movimientos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,descripcion,monto})});
      if(!r.ok){ msgErr(qs('mov-result'),'Error al agregar'); return; }
      msgOK(qs('mov-result'),'Movimiento agregado');
      e.target.reset();
      await refreshMovTable(); await refreshTotal();
    };

    // ===== init
    (function init(){
      document.querySelectorAll('.nav-link').forEach(n=>n.classList.add('disabled'));
      loadRolesIntoSelect('user-rol-id');
      loadRolesIntoSelect('update-user-rol-id');
      loadUsersIntoSelect('factura-usuario-id'); // si usas el flujo crear factura
      showPage('login');
    })();
  </script>
</body>
</html>
